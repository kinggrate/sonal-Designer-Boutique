<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonal Designer Boutique - Orders Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='images/WhatsApp-Image-2025-07-06-at-18.34.54_726adc49.jpg') }}" alt="Sonal Designer Boutique" class="logo" onerror="this.style.display='none';">
                <div>
                    <h1 class="main-title">Sonal Designer Boutique</h1>
                    <p class="subtitle">Fashion Designing Training Institute</p>
                </div>
            </div>
        </header>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <label for="searchInput" class="visually-hidden">Search Customers</label>
                    <i class="fas fa-search search-icon" aria-hidden="true"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search customers by name or phone..." autocomplete="off">
                </div>
                <div class="search-actions">
                    <button id="addNewBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i>
                        <span>Add New Customer</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Customer Form Modal -->
        <div id="customerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Add New Customer</h2>
                    <span class="close" id="customerCloseBtn">&times;</span>
                </div>
                <form id="customerForm" class="customer-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName"><i class="fas fa-user"></i> Customer Name</label>
                            <input type="text" id="customerName" name="customer_name" required placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber"><i class="fas fa-phone"></i> Phone Number</label>
                            <input type="tel" id="phoneNumber" name="phone_number" required placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <!-- Measurements List -->
                    <div class="measurements-section">
                        <h3><i class="fas fa-ruler"></i> Measurements Added: <span id="measurementCount">0</span></h3>
                        <div id="measurementsList"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-add" id="addMeasurementBtn">
                            <i class="fas fa-plus"></i> Add Measurements
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save"></i> Save Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Measurement Modal -->
        <div id="measurementModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-ruler-combined"></i> Add Garment Measurements</h2>
                    <span class="close" id="measurementCloseBtn">&times;</span>
                </div>
                <form id="measurementForm">
                    <!-- Garment Type Selection -->
                    <div class="form-group">
                        <label><i class="fas fa-tshirt"></i> Select Garment Type</label>
                        <div class="garment-type-checkboxes">
                            <label>
                                <input type="checkbox" name="garment_type" value="blouse">
                                <span><i class="fas fa-female"></i> Blouse</span>
                            </label>
                            <label>
                                <input type="checkbox" name="garment_type" value="pant">
                                <span><i class="fas fa-male"></i> Pant</span>
                            </label>
                            <label>
                                <input type="checkbox" name="garment_type" value="dress">
                                <span><i class="fas fa-dress"></i> Dress</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="measurementDeliveryDate"><i class="fas fa-calendar"></i> Delivery Date</label>
                            <input type="date" id="measurementDeliveryDate" name="delivery_date" required>
                        </div>
                        <div class="form-group">
                            <label for="measurementNotes"><i class="fas fa-sticky-note"></i> Additional Notes</label>
                            <textarea id="measurementNotes" name="additional_notes" rows="2" placeholder="Special instructions for this garment..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Dynamic Measurement Fields -->
                    <div id="dynamicMeasurementFields"></div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelMeasurementBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="saveMeasurementBtn">
                            <i class="fas fa-save"></i> Save Measurements
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Customer Modal -->
        <div id="editCustomerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-edit"></i> Edit Customer</h2>
                    <span class="close" id="editCustomerCloseBtn">&times;</span>
                </div>
                <form id="editCustomerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editCustomerName"><i class="fas fa-user"></i> Customer Name</label>
                            <input type="text" id="editCustomerName" name="customer_name" required>
                        </div>
                        <div class="form-group">
                            <label for="editPhoneNumber"><i class="fas fa-phone"></i> Phone Number</label>
                            <input type="tel" id="editPhoneNumber" name="phone_number" required>
                        </div>
                    </div>
                    
                    <!-- Customer's Existing Measurements -->
                    <div class="customer-measurements-section">
                        <h3><i class="fas fa-ruler-combined"></i> Customer's Measurements</h3>
                        <div id="customerMeasurementsList"></div>
                        <button type="button" class="btn btn-add" id="addNewMeasurementBtn">
                            <i class="fas fa-plus"></i> Add New Measurement
                        </button>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Measurement Modal -->
        <div id="editMeasurementModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Edit Measurement</h2>
                    <span class="close" id="editMeasurementCloseBtn">&times;</span>
                </div>
                <form id="editMeasurementForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editMeasurementDeliveryDate"><i class="fas fa-calendar"></i> Delivery Date</label>
                            <input type="date" id="editMeasurementDeliveryDate" name="delivery_date" required>
                        </div>
                        <div class="form-group">
                            <label for="editMeasurementNotes"><i class="fas fa-sticky-note"></i> Additional Notes</label>
                            <textarea id="editMeasurementNotes" name="additional_notes" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <!-- Dynamic Edit Fields -->
                    <div id="dynamicEditFields"></div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEditMeasurementBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Measurement
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Measurement to Existing Customer Modal -->
        <div id="addMeasurementToCustomerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-plus"></i> Add Measurement to <span id="customerNameSpan"></span></h2>
                    <span class="close" id="addMeasurementToCustomerCloseBtn">&times;</span>
                </div>
                <form id="addMeasurementToCustomerForm">
                    <!-- Garment Type Selection -->
                    <div class="form-group">
                        <label><i class="fas fa-tshirt"></i> Select Garment Type</label>
                        <div class="garment-type-radios">
                            <label>
                                <input type="radio" name="new_garment_type" value="blouse">
                                <span><i class="fas fa-female"></i> Blouse</span>
                            </label>
                            <label>
                                <input type="radio" name="new_garment_type" value="pant">
                                <span><i class="fas fa-male"></i> Pant</span>
                            </label>
                            <label>
                                <input type="radio" name="new_garment_type" value="dress">
                                <span><i class="fas fa-dress"></i> Dress</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newMeasurementDeliveryDate"><i class="fas fa-calendar"></i> Delivery Date</label>
                            <input type="date" id="newMeasurementDeliveryDate" name="delivery_date" required>
                        </div>
                        <div class="form-group">
                            <label for="newMeasurementNotes"><i class="fas fa-sticky-note"></i> Additional Notes</label>
                            <textarea id="newMeasurementNotes" name="additional_notes" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <!-- Dynamic Fields for New Measurement -->
                    <div id="dynamicNewMeasurementFields"></div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelAddMeasurementToCustomerBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Measurement
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Customers List -->
        <section class="customers-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Customer Orders</h2>
                <div class="header-actions">
                    <div class="customers-count">
                        <i class="fas fa-user"></i> <span id="customersCount">0</span> customers
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
            <div id="customersList" class="customers-list">
                <!-- Customers will be loaded here -->
            </div>
        </section>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Modal elements
            const addBtn = document.getElementById('addNewBtn');
            const customerModal = document.getElementById('customerModal');
            const customerCloseBtn = document.getElementById('customerCloseBtn');
            const addMeasurementBtn = document.getElementById('addMeasurementBtn');
            const measurementModal = document.getElementById('measurementModal');
            const measurementCloseBtn = document.getElementById('measurementCloseBtn');
            const cancelMeasurementBtn = document.getElementById('cancelMeasurementBtn');
            const saveMeasurementBtn = document.getElementById('saveMeasurementBtn');
            
            // Edit modals
            const editCustomerModal = document.getElementById('editCustomerModal');
            const editCustomerCloseBtn = document.getElementById('editCustomerCloseBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const editMeasurementModal = document.getElementById('editMeasurementModal');
            const editMeasurementCloseBtn = document.getElementById('editMeasurementCloseBtn');
            const cancelEditMeasurementBtn = document.getElementById('cancelEditMeasurementBtn');
            
            // Add measurement to existing customer modal
            const addMeasurementToCustomerModal = document.getElementById('addMeasurementToCustomerModal');
            const addMeasurementToCustomerCloseBtn = document.getElementById('addMeasurementToCustomerCloseBtn');
            const cancelAddMeasurementToCustomerBtn = document.getElementById('cancelAddMeasurementToCustomerBtn');
            const addNewMeasurementBtn = document.getElementById('addNewMeasurementBtn');
            
            // Forms
            const customerForm = document.getElementById('customerForm');
            const measurementForm = document.getElementById('measurementForm');
            const editCustomerForm = document.getElementById('editCustomerForm');
            const editMeasurementForm = document.getElementById('editMeasurementForm');
            const addMeasurementToCustomerForm = document.getElementById('addMeasurementToCustomerForm');
            const dynamicFields = document.getElementById('dynamicMeasurementFields');
            const dynamicEditFields = document.getElementById('dynamicEditFields');
            const dynamicNewMeasurementFields = document.getElementById('dynamicNewMeasurementFields');
            const measurementsList = document.getElementById('measurementsList');
            const measurementCount = document.getElementById('measurementCount');
            const customerMeasurementsList = document.getElementById('customerMeasurementsList');
            
            // Cancel button
            const cancelBtn = document.getElementById('cancelBtn');
            
            // Search
            const searchInput = document.getElementById('searchInput');
            
            // Store measurements temporarily
            let currentMeasurements = [];
            let editingCustomerId = null;
            let editingMeasurementId = null;
            let allCustomers = []; // Store all customers for search

            // Cancel button event handler
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    customerModal.style.display = 'none';
                    currentMeasurements = [];
                    customerForm.reset();
                    updateMeasurementsList();
                });
            }

            // Search functionality with debounce
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = this.value.trim();
                    searchCustomers(query);
                }, 300);
            });

            function searchCustomers(query) {
                if (!query) {
                    displayCustomers(allCustomers);
                    return;
                }

                const filteredCustomers = allCustomers.filter(customer => 
                    customer.customer_name.toLowerCase().includes(query.toLowerCase()) ||
                    customer.phone_number.includes(query)
                );
                displayCustomers(filteredCustomers);
            }

            // Open customer modal
            if (addBtn && customerModal) {
                addBtn.addEventListener('click', function() {
                    customerModal.style.display = 'block';
                    document.getElementById('modalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    currentMeasurements = [];
                    updateMeasurementsList();
                });
            }

            // Close customer modal
            if (customerCloseBtn) {
                customerCloseBtn.addEventListener('click', function() {
                    customerModal.style.display = 'none';
                    currentMeasurements = [];
                });
            }

            // Open measurement modal
            if (addMeasurementBtn && measurementModal) {
                addMeasurementBtn.addEventListener('click', function() {
                    measurementModal.style.display = 'block';
                    measurementForm.reset();
                    dynamicFields.innerHTML = '';
                });
            }

            // Close measurement modal
            if (measurementCloseBtn) {
                measurementCloseBtn.addEventListener('click', function() {
                    measurementModal.style.display = 'none';
                });
            }

            if (cancelMeasurementBtn) {
                cancelMeasurementBtn.addEventListener('click', function() {
                    measurementModal.style.display = 'none';
                });
            }

            // Close edit modals
            if (editCustomerCloseBtn) {
                editCustomerCloseBtn.addEventListener('click', () => editCustomerModal.style.display = 'none');
            }
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => editCustomerModal.style.display = 'none');
            }
            if (editMeasurementCloseBtn) {
                editMeasurementCloseBtn.addEventListener('click', () => editMeasurementModal.style.display = 'none');
            }
            if (cancelEditMeasurementBtn) {
                cancelEditMeasurementBtn.addEventListener('click', () => editMeasurementModal.style.display = 'none');
            }
            
            // Close add measurement to customer modal
            if (addMeasurementToCustomerCloseBtn) {
                addMeasurementToCustomerCloseBtn.addEventListener('click', () => addMeasurementToCustomerModal.style.display = 'none');
            }
            if (cancelAddMeasurementToCustomerBtn) {
                cancelAddMeasurementToCustomerBtn.addEventListener('click', () => addMeasurementToCustomerModal.style.display = 'none');
            }

            // Measurement fields templates
            const garmentFields = {
                blouse: `
                    <div class="garment-fields">
                        <h3><i class="fas fa-female"></i> Blouse Measurements (in inches)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Shoulder</label>
                                <input type="text" name="shoulder" placeholder="Shoulder measurement">
                            </div>
                            <div class="form-group">
                                <label>Chest</label>
                                <input type="text" name="chest" placeholder="Chest measurement">
                            </div>
                            <div class="form-group">
                                <label>Bust</label>
                                <input type="text" name="bust" placeholder="Bust measurement">
                            </div>
                            <div class="form-group">
                                <label>Waist</label>
                                <input type="text" name="waist" placeholder="Waist measurement">
                            </div>
                            <div class="form-group">
                                <label>Bust Point</label>
                                <input type="text" name="bust_point" placeholder="Bust point">
                            </div>
                            <div class="form-group">
                                <label>Bust to Bust</label>
                                <input type="text" name="bust_to_bust" placeholder="Bust to bust">
                            </div>
                            <div class="form-group">
                                <label>Sleeves</label>
                                <input type="text" name="sleeves" placeholder="Sleeves measurement">
                            </div>
                            <div class="form-group">
                                <label>Penalty Crease</label>
                                <input type="text" name="penalty_crease" placeholder="Penalty crease">
                            </div>
                            <div class="form-group">
                                <label>Back Neck</label>
                                <input type="text" name="back_neck" placeholder="Back neck">
                            </div>
                            <div class="form-group">
                                <label>Front Neck</label>
                                <input type="text" name="front_neck" placeholder="Front neck">
                            </div>
                            <div class="form-group">
                                <label>Length</label>
                                <input type="text" name="length" placeholder="Length measurement">
                            </div>
                            <div class="form-group">
                                <label>Lower Chest</label>
                                <input type="text" name="lower_chest" placeholder="Lower chest">
                            </div>
                            <div class="form-group">
                                <label>Neck Round</label>
                                <input type="text" name="neck_round" placeholder="Neck round">
                            </div>
                        </div>
                    </div>`,
                pant: `
                    <div class="garment-fields">
                        <h3><i class="fas fa-male"></i> Pant Measurements (in inches)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Waist</label>
                                <input type="text" name="pant_waist" placeholder="Waist measurement">
                            </div>
                            <div class="form-group">
                                <label>Hip</label>
                                <input type="text" name="hip" placeholder="Hip measurement">
                            </div>
                            <div class="form-group">
                                <label>Length</label>
                                <input type="text" name="pant_length" placeholder="Length measurement">
                            </div>
                            <div class="form-group">
                                <label>Thigh</label>
                                <input type="text" name="thigh" placeholder="Thigh measurement">
                            </div>
                            <div class="form-group">
                                <label>Knee</label>
                                <input type="text" name="knee" placeholder="Knee measurement">
                            </div>
                            <div class="form-group">
                                <label>Bottom</label>
                                <input type="text" name="bottom" placeholder="Bottom measurement">
                            </div>
                        </div>
                    </div>`,
                dress: `
                    <div class="garment-fields">
                        <h3><i class="fas fa-dress"></i> Dress Measurements (in inches)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Shoulder</label>
                                <input type="text" name="dress_shoulder" placeholder="Shoulder measurement">
                            </div>
                            <div class="form-group">
                                <label>Chest</label>
                                <input type="text" name="dress_chest" placeholder="Chest measurement">
                            </div>
                            <div class="form-group">
                                <label>Waist</label>
                                <input type="text" name="dress_waist" placeholder="Waist measurement">
                            </div>
                            <div class="form-group">
                                <label>Hip</label>
                                <input type="text" name="dress_hip" placeholder="Hip measurement">
                            </div>
                            <div class="form-group">
                                <label>Length</label>
                                <input type="text" name="dress_length" placeholder="Length measurement">
                            </div>
                            <div class="form-group">
                                <label>Arm Whole Round</label>
                                <input type="text" name="arm_whole_round" placeholder="Arm whole round">
                            </div>
                            <div class="form-group">
                                <label>Sleeves</label>
                                <input type="text" name="dress_sleeves" placeholder="Sleeves measurement">
                            </div>
                            <div class="form-group">
                                <label>Penalty Circle</label>
                                <input type="text" name="penalty_circle" placeholder="Penalty circle">
                            </div>
                            <div class="form-group">
                                <label>Front Neck</label>
                                <input type="text" name="dress_front_neck" placeholder="Front neck">
                            </div>
                            <div class="form-group">
                                <label>Back Neck</label>
                                <input type="text" name="dress_back_neck" placeholder="Back neck">
                            </div>
                            <div class="form-group">
                                <label>Matha Round</label>
                                <input type="text" name="matha_round" placeholder="Matha round">
                            </div>
                        </div>
                    </div>`
            };

            // Handle garment type selection for all modals
            document.addEventListener('change', function(e) {
                if (e.target.name === 'garment_type') {
                    const container = e.target.closest('.modal').querySelector('#dynamicMeasurementFields, #dynamicEditFields');
                    if (container) {
                        container.innerHTML = garmentFields[e.target.value];
                    }
                }
                
                if (e.target.name === 'new_garment_type') {
                    const container = e.target.closest('.modal').querySelector('#dynamicNewMeasurementFields');
                    if (container) {
                        container.innerHTML = garmentFields[e.target.value];
                    }
                }
            });

            // Update measurements list display
            function updateMeasurementsList() {
                measurementCount.textContent = currentMeasurements.length;
                measurementsList.innerHTML = currentMeasurements.map((m, index) => `
                    <div class="measurement-item">
                        <span><i class="fas fa-tshirt"></i> ${m.garment_type.charAt(0).toUpperCase() + m.garment_type.slice(1)} - ${m.delivery_date}</span>
                        <button type="button" onclick="removeMeasurement(${index})" class="btn-small btn-delete">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                `).join('');
            }

            // Remove measurement from list
            window.removeMeasurement = function(index) {
                currentMeasurements.splice(index, 1);
                updateMeasurementsList();
            };

            // Save measurement to temporary storage
            if (saveMeasurementBtn) {
                saveMeasurementBtn.addEventListener('click', function() {
                    console.log('Save measurement clicked');
                    
                    // Get selected garment type
                    const selectedType = document.querySelector('#measurementModal input[name="garment_type"]:checked');
                    if (!selectedType) {
                        alert('Please select a garment type!');
                        return;
                    }

                    const deliveryDate = document.getElementById('measurementDeliveryDate').value;
                    if (!deliveryDate) {
                        alert('Please enter a delivery date!');
                        return;
                    }

                    // Collect measurement data
                    const measurementData = {
                        garment_type: selectedType.value,
                        delivery_date: deliveryDate,
                        additional_notes: document.getElementById('measurementNotes').value
                    };

                    // Get all measurement inputs
                    const inputs = dynamicFields.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (input.value.trim()) {
                            measurementData[input.name] = input.value.trim();
                        }
                    });

                    // Store measurement temporarily
                    currentMeasurements.push(measurementData);
                    updateMeasurementsList();

                    // Close measurement modal
                    measurementModal.style.display = 'none';
                    
                    // Reset measurement form
                    measurementForm.reset();
                    dynamicFields.innerHTML = '';
                    
                    // Show success message
                    alert(`✅ ${selectedType.value.charAt(0).toUpperCase() + selectedType.value.slice(1)} measurement added! Click "Save Customer" to save everything.`);
                });
            }

            // Customer form submission
            customerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Customer form submitted');

                if (currentMeasurements.length === 0) {
                    if (!confirm('No measurements added. Save customer without measurements?')) {
                        return;
                    }
                }

                // Collect customer data
                const customerData = {
                    customer_name: document.getElementById('customerName').value,
                    phone_number: document.getElementById('phoneNumber').value,
                    measurements: currentMeasurements
                };

                console.log('Sending data:', customerData);

                // Send to backend
                fetch('/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                })
                .then(res => {
                    console.log('Response status:', res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    
                    // Check for success
                    if (data.message && data.message.includes('successfully')) {
                        alert('✅ Customer and measurements saved successfully!');
                        
                        // Close modal and reset
                        customerModal.style.display = 'none';
                        customerForm.reset();
                        currentMeasurements = [];
                        updateMeasurementsList();
                        
                        // Reload customer list
                        loadCustomers();
                    } else {
                        alert('❌ Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('❌ Error: ' + err.message);
                });
            });

            // Edit customer functionality with measurements
            window.editCustomer = function(customerId) {
                editingCustomerId = customerId;
                
                // Find customer from stored data
                const customer = allCustomers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('editCustomerName').value = customer.customer_name;
                    document.getElementById('editPhoneNumber').value = customer.phone_number;
                    
                    // Display customer's measurements with collapsible feature
                    displayCustomerMeasurements(customer.measurements);
                    
                    editCustomerModal.style.display = 'block';
                } else {
                    alert('❌ Customer not found!');
                }
            };

            // NEW: Display customer measurements with collapsible groups by garment type
            function displayCustomerMeasurements(measurements) {
                // Group measurements by garment type
                const groupedMeasurements = {};
                measurements.forEach(measurement => {
                    if (!groupedMeasurements[measurement.garment_type]) {
                        groupedMeasurements[measurement.garment_type] = [];
                    }
                    groupedMeasurements[measurement.garment_type].push(measurement);
                });

                let html = '';
                Object.keys(groupedMeasurements).forEach(garmentType => {
                    const garmentMeasurements = groupedMeasurements[garmentType];
                    const garmentIcon = garmentType === 'blouse' ? 'fa-female' : 
                                      garmentType === 'pant' ? 'fa-male' : 'fa-dress';
                    
                    html += `
                        <div class="garment-measurements-group">
                            <button type="button" class="measurements-toggle" onclick="toggleMeasurements('${garmentType}')">
                                <span><i class="fas ${garmentIcon}"></i> ${garmentType.charAt(0).toUpperCase() + garmentType.slice(1)} Measurements (${garmentMeasurements.length})</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="measurements-container" id="measurements-${garmentType}">
                                ${garmentMeasurements.map(measurement => `
                                    <div class="measurement-card">
                                        <div class="measurement-info">
                                            <strong><i class="fas fa-calendar"></i> Delivery: ${measurement.delivery_date}</strong>
                                            ${measurement.additional_notes ? `<span><i class="fas fa-sticky-note"></i> Notes: ${measurement.additional_notes}</span>` : ''}
                                            ${generateMeasurementDetails(measurement)}
                                        </div>
                                        <div class="measurement-actions">
                                            <button onclick="editMeasurement(${measurement.id})" class="btn-small btn-edit">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button onclick="deleteMeasurement(${measurement.id})" class="btn-small btn-delete">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                customerMeasurementsList.innerHTML = html;
            }

            // NEW: Toggle measurements visibility
            window.toggleMeasurements = function(garmentType) {
                const container = document.getElementById(`measurements-${garmentType}`);
                const toggle = container.previousElementSibling;
                
                if (container.classList.contains('expanded')) {
                    container.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                } else {
                    container.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
            };

            // NEW: Generate measurement details for display
            function generateMeasurementDetails(measurement) {
                let details = '<div class="measurement-details">';
                
                if (measurement.garment_type === 'blouse') {
                    const fields = ['shoulder', 'chest', 'waist', 'bust', 'bust_point', 'bust_to_bust', 'sleeves', 'penalty_crease', 'back_neck', 'front_neck', 'length', 'lower_chest', 'neck_round'];
                    fields.forEach(field => {
                        if (measurement[field]) {
                            details += `<span>${field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: ${measurement[field]}"</span>`;
                        }
                    });
                } else if (measurement.garment_type === 'pant') {
                    const fields = ['pant_waist', 'pant_length', 'thigh', 'knee', 'bottom', 'hip'];
                    fields.forEach(field => {
                        if (measurement[field]) {
                            details += `<span>${field.replace(/pant_|_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: ${measurement[field]}"</span>`;
                        }
                    });
                } else if (measurement.garment_type === 'dress') {
                    const fields = ['dress_shoulder', 'dress_chest', 'dress_waist', 'dress_hip', 'dress_length', 'arm_whole_round', 'dress_sleeves', 'penalty_circle', 'dress_front_neck', 'dress_back_neck', 'matha_round'];
                    fields.forEach(field => {
                        if (measurement[field]) {
                            details += `<span>${field.replace(/dress_|_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: ${measurement[field]}"</span>`;
                        }
                    });
                }
                
                details += '</div>';
                return details;
            }

            // Add measurement to existing customer
            if (addNewMeasurementBtn) {
                addNewMeasurementBtn.addEventListener('click', function() {
                    const customer = allCustomers.find(c => c.id === editingCustomerId);
                    if (customer) {
                        document.getElementById('customerNameSpan').textContent = customer.customer_name;
                        editCustomerModal.style.display = 'none';
                        addMeasurementToCustomerModal.style.display = 'block';
                    }
                });
            }

            // Add measurement to customer form submission
            addMeasurementToCustomerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const selectedType = document.querySelector('input[name="new_garment_type"]:checked');
                if (!selectedType) {
                    alert('Please select a garment type!');
                    return;
                }

                const measurementData = {
                    customer_id: editingCustomerId,
                    garment_type: selectedType.value,
                    delivery_date: document.getElementById('newMeasurementDeliveryDate').value,
                    additional_notes: document.getElementById('newMeasurementNotes').value
                };

                // Get all measurement inputs
                const inputs = dynamicNewMeasurementFields.querySelectorAll('input');
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        measurementData[input.name] = input.value.trim();
                    }
                });

                fetch('/api/measurements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(measurementData)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message && data.message.includes('successfully')) {
                        alert('✅ Measurement added successfully!');
                        addMeasurementToCustomerModal.style.display = 'none';
                        addMeasurementToCustomerForm.reset();
                        dynamicNewMeasurementFields.innerHTML = '';
                        loadCustomers();
                        // Reopen edit customer modal
                        setTimeout(() => editCustomer(editingCustomerId), 100);
                    } else {
                        alert('❌ Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('❌ Error: ' + err.message);
                });
            });

            // Edit customer form submission
            editCustomerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const customerData = {
                    customer_name: document.getElementById('editCustomerName').value,
                    phone_number: document.getElementById('editPhoneNumber').value
                };

                fetch(`/api/customers/${editingCustomerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message && data.message.includes('successfully')) {
                        alert('✅ Customer updated successfully!');
                        editCustomerModal.style.display = 'none';
                        loadCustomers();
                    } else {
                        alert('❌ Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('❌ Error: ' + err.message);
                });
            });

            // Edit measurement functionality
            window.editMeasurement = function(measurementId) {
                console.log('Edit measurement clicked for ID:', measurementId);
                editingMeasurementId = measurementId;
                
                // Find the measurement from stored data
                let measurement = null;
                for (const customer of allCustomers) {
                    measurement = customer.measurements.find(m => m.id === measurementId);
                    if (measurement) break;
                }
                
                if (measurement) {
                    console.log('Found measurement:', measurement);
                    
                    // Fill form fields
                    document.getElementById('editMeasurementDeliveryDate').value = measurement.delivery_date || '';
                    document.getElementById('editMeasurementNotes').value = measurement.additional_notes || '';
                    
                    // Show measurement fields based on garment type
                    dynamicEditFields.innerHTML = garmentFields[measurement.garment_type];
                    
                    // Fill in measurement values
                    const inputs = dynamicEditFields.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (measurement[input.name] !== null && measurement[input.name] !== undefined) {
                            input.value = measurement[input.name];
                        }
                    });
                    
                    editCustomerModal.style.display = 'none';
                    editMeasurementModal.style.display = 'block';
                } else {
                    alert('❌ Measurement not found!');
                    console.error('Measurement not found for ID:', measurementId);
                }
            };

            // Edit measurement form submission
            editMeasurementForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const measurementData = {
                    delivery_date: document.getElementById('editMeasurementDeliveryDate').value,
                    additional_notes: document.getElementById('editMeasurementNotes').value
                };

                // Get all measurement inputs
                const inputs = dynamicEditFields.querySelectorAll('input');
                inputs.forEach(input => {
                    measurementData[input.name] = input.value.trim() || null;
                });

                console.log('Updating measurement:', editingMeasurementId, measurementData);

                fetch(`/api/measurements/${editingMeasurementId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(measurementData)
                })
                .then(res => res.json())
                .then(data => {
                    console.log('Update response:', data);
                    if (data.message && data.message.includes('successfully')) {
                        alert('✅ Measurement updated successfully!');
                        editMeasurementModal.style.display = 'none';
                        loadCustomers();
                        // Reopen edit customer modal
                        setTimeout(() => editCustomer(editingCustomerId), 100);
                    } else {
                        alert('❌ Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('❌ Error: ' + err.message);
                });
            });

            // Delete functions
            window.deleteCustomer = function(customerId) {
                if (confirm('⚠️ Are you sure you want to delete this customer and all their measurements?')) {
                    fetch(`/api/customers/${customerId}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.message && data.message.includes('successfully')) {
                            alert('✅ Customer deleted successfully!');
                            loadCustomers();
                        } else {
                            alert('❌ Error: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('❌ Error: ' + err.message);
                    });
                }
            };

            window.deleteMeasurement = function(measurementId) {
                if (confirm('⚠️ Are you sure you want to delete this measurement?')) {
                    fetch(`/api/measurements/${measurementId}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.message && data.message.includes('successfully')) {
                            alert('✅ Measurement deleted successfully!');
                            loadCustomers();
                            // Reopen edit customer modal if it was open
                            if (editingCustomerId) {
                                setTimeout(() => editCustomer(editingCustomerId), 100);
                            }
                        } else {
                            alert('❌ Error: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('❌ Error: ' + err.message);
                    });
                }
            };

            // Display customers function with collapsible measurements
            function displayCustomers(customers) {
                const customersList = document.getElementById('customersList');
                const customersCount = document.getElementById('customersCount');
                
                if (customersCount) {
                    customersCount.textContent = customers.length;
                }
                
                if (customersList) {
                    if (customers.length === 0) {
                        customersList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No customers found</h3>
                                <p>Add your first customer to get started!</p>
                            </div>
                        `;
                        return;
                    }

                    customersList.innerHTML = customers.map(customer => `
                        <div class="customer-card">
                            <div class="customer-header">
                                <div>
                                    <h3><i class="fas fa-user"></i> ${customer.customer_name}</h3>
                                    <p><i class="fas fa-phone"></i> <strong>Phone:</strong> ${customer.phone_number}</p>
                                    <p><i class="fas fa-ruler"></i> <strong>Measurements:</strong> ${customer.measurements.length}</p>
                                </div>
                                <div class="customer-actions">
                                    <button onclick="editCustomer(${customer.id})" class="btn-small btn-edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="deleteCustomer(${customer.id})" class="btn-small btn-delete">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            
                            ${customer.measurements.length > 0 ? `
                                <div class="measurements-list">
                                    <button class="measurements-toggle" onclick="toggleCustomerMeasurements(${customer.id})">
                                        <span><i class="fas fa-ruler-combined"></i> View Measurements (${customer.measurements.length})</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="measurements-container" id="customer-measurements-${customer.id}">
                                        ${generateCustomerMeasurementsDisplay(customer.measurements)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
            }

            // NEW: Toggle customer measurements in main display
            window.toggleCustomerMeasurements = function(customerId) {
                const container = document.getElementById(`customer-measurements-${customerId}`);
                const toggle = container.previousElementSibling;
                
                if (container.classList.contains('expanded')) {
                    container.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                } else {
                    container.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
            };

            // NEW: Generate customer measurements display
            function generateCustomerMeasurementsDisplay(measurements) {
                return measurements.map(measurement => `
                    <div class="measurement-card">
                        <div class="measurement-info">
                            <strong><i class="fas fa-tshirt"></i> ${measurement.garment_type.charAt(0).toUpperCase() + measurement.garment_type.slice(1)}</strong>
                            <span><i class="fas fa-calendar"></i> Delivery: ${measurement.delivery_date}</span>
                            ${measurement.additional_notes ? `<span><i class="fas fa-sticky-note"></i> Notes: ${measurement.additional_notes}</span>` : ''}
                        </div>
                        <div class="measurement-actions">
                            <button onclick="editMeasurement(${measurement.id})" class="btn-small btn-edit">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteMeasurement(${measurement.id})" class="btn-small btn-delete">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Load customers function
            function loadCustomers() {
                fetch('/api/customers')
                    .then(res => res.json())
                    .then(customers => {
                        allCustomers = customers; // Store for search
                        displayCustomers(customers);
                    })
                    .catch(err => {
                        console.error('Error loading customers:', err);
                        alert('❌ Error loading customers: ' + err.message);
                    });
            }

            // Load customers on page load
            loadCustomers();

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>