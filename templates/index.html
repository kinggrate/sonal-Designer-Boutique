<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonal Designer Boutique - Orders Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='images/WhatsApp Image 2025-07-06 at 18.34.54_726adc49.jpg') }}" alt="Sonal Designer Boutique" class="logo">
            </div>
            <h1 class="main-title">Orders Management System</h1>
            <p class="subtitle">Fashion Designing Training Institute</p>
        </header>

        <!-- Search Section -->
        <section class="search-section">
          <div class="search-container">
            
            <!-- Search Box -->
            <div class="search-box">
              <label for="searchInput" class="visually-hidden">Search Customers</label>
              <i class="fas fa-search search-icon" aria-hidden="true"></i>
              <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search customers by name or phone..." 
            autocomplete="off">
            </div>

            <!-- Add Customer Button -->
            <div class="search-actions">
              <button id="addNewBtn" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span>Add New Customer</span>
              </button>
            </div>

          </div>
        </section>

        <!-- Customer Form Modal -->
        <div id="customerModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="modalTitle">Add New Customer</h2>
              <span class="close">&times;</span>
            </div>
            <form id="customerForm" class="customer-form" action="#" method="POST">
              <div class="form-grid">
                <div class="form-group">
                  <label for="customerName">Customer Name *</label>
                  <input type="text" id="customerName" name="customer_name" required>
                </div>
                <div class="form-group">
                  <label for="phoneNumber">Phone Number *</label>
                  <input type="tel" id="phoneNumber" name="phone_number" required>
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label for="deliveryDate">Delivery Date *</label>
                  <input type="date" id="deliveryDate" name="delivery_date" required>
                </div>
                <div class="form-group full-width">
                  <label for="additionalNotes">Additional Notes</label>
                  <textarea id="additionalNotes" name="additional_notes" rows="3" placeholder="Any special instructions or notes..."></textarea>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="addMeasurementBtn">Add Measurement for this Customer</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Save Customer</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Measurement Modal (Dynamic) -->
        <div id="measurementModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Add Garment Measurements</h2>
              <span class="close">&times;</span>
            </div>
            <form id="measurementForm" action="#" method="POST">
              <input type="hidden" id="measurementCustomerId" name="customer_id">
              <div class="form-group">
                <label>Select Garment Types *</label>
                <div class="garment-type-checkboxes">
                  <label><input type="checkbox" name="garment_types" value="blouse"> Blouse</label>
                  <label><input type="checkbox" name="garment_types" value="pant"> Pant</label>
                  <label><input type="checkbox" name="garment_types" value="dress"> Dress</label>
                </div>
              </div>
              <div id="dynamicMeasurementFields">
                <!-- Dynamic measurement fields will be injected here -->
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelMeasurementBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Measurements</button>
              </div>
            </form>
          </div>
        </div>

        <!-- JS Logic -->
        <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Modal logic
    const addBtn = document.getElementById("addNewBtn");
    const customerModal = document.getElementById("customerModal");
    const customerCloseBtn = document.querySelector("#customerModal .close");
    const addMeasurementBtn = document.getElementById('addMeasurementBtn');
    const measurementModal = document.getElementById('measurementModal');
    const measurementCloseBtn = document.querySelector("#measurementModal .close");
    const cancelMeasurementBtn = document.getElementById("cancelMeasurementBtn");
    const customerForm = document.getElementById('customerForm');
    const measurementForm = document.getElementById('measurementForm');
    const dynamicFields = document.getElementById('dynamicMeasurementFields');

    // Open customer modal
    if (addBtn && customerModal) {
      addBtn.addEventListener("click", function () {
        customerModal.style.display = "block";
      });
    }
    // Close customer modal
    if (customerCloseBtn) {
      customerCloseBtn.addEventListener("click", function () {
        customerModal.style.display = "none";
      });
    }
    // Open measurement modal
    if (addMeasurementBtn && measurementModal) {
      addMeasurementBtn.addEventListener('click', function () {
        measurementModal.style.display = 'block';
      });
    }
    // Close measurement modal
    if (measurementCloseBtn) {
      measurementCloseBtn.addEventListener("click", function () {
        measurementModal.style.display = "none";
      });
    }
    if (cancelMeasurementBtn) {
      cancelMeasurementBtn.addEventListener("click", function () {
        measurementModal.style.display = "none";
      });
    }

    // Dynamic measurement fields logic
    const garmentFields = {
      blouse: `<div class='garment-fields'><h3>Blouse Measurements</h3><div class='form-grid'>
        <input type='text' name='shoulder' placeholder='Shoulder'>
        <input type='text' name='chest' placeholder='Chest'>
        <input type='text' name='bust' placeholder='Bust'>
        <input type='text' name='waist' placeholder='Waist'>
        <input type='text' name='bust_point' placeholder='Bust Point'>
        <input type='text' name='bust_to_bust' placeholder='Bust to Bust'>
        <input type='text' name='sleeves' placeholder='Sleeves'>
        <input type='text' name='penalty_crease' placeholder='Penalty Crease'>
        <input type='text' name='back_neck' placeholder='Back Neck'>
        <input type='text' name='front_neck' placeholder='Front Neck'>
        <input type='text' name='length' placeholder='Length'>
        <input type='text' name='lower_chest' placeholder='Lower Chest'>
        <input type='text' name='neck_round' placeholder='Neck Round'>
      </div></div>`,
      pant: `<div class='garment-fields'><h3>Pant Measurements</h3><div class='form-grid'>
        <input type='text' name='pant_waist' placeholder='Waist'>
        <input type='text' name='hip' placeholder='Hip'>
        <input type='text' name='pant_length' placeholder='Length'>
        <input type='text' name='thigh' placeholder='Thigh'>
        <input type='text' name='knee' placeholder='Knee'>
        <input type='text' name='bottom' placeholder='Bottom'>
      </div></div>`,
      dress: `<div class='garment-fields'><h3>Dress Measurements</h3><div class='form-grid'>
        <input type='text' name='dress_shoulder' placeholder='Shoulder'>
        <input type='text' name='dress_chest' placeholder='Chest'>
        <input type='text' name='dress_waist' placeholder='Waist'>
        <input type='text' name='dress_hip' placeholder='Hip'>
        <input type='text' name='dress_length' placeholder='Length'>
        <input type='text' name='arm_whole_round' placeholder='Arm Whole Round'>
        <input type='text' name='dress_sleeves' placeholder='Sleeves'>
        <input type='text' name='penalty_circle' placeholder='Penalty Circle'>
        <input type='text' name='dress_front_neck' placeholder='Front Neck'>
        <input type='text' name='dress_back_neck' placeholder='Back Neck'>
        <input type='text' name='matha_round' placeholder='Matha Round'>
      </div></div>`
    };

    const garmentTypeCheckboxes = document.querySelectorAll('input[name="garment_types"]');
    garmentTypeCheckboxes.forEach(function (checkbox) {
      checkbox.addEventListener('change', function () {
        dynamicFields.innerHTML = '';
        garmentTypeCheckboxes.forEach(function (cb) {
          if (cb.checked) {
            dynamicFields.innerHTML += garmentFields[cb.value];
          }
        });
      });
    });

    // Submit customer and measurements together
    customerForm.addEventListener('submit', function (e) {
      console.log("Customer form submit handler running"); // Debug log
      e.preventDefault(); // Prevent default form submission
      // Collect customer info
      const customerData = {
        customer_name: document.getElementById('customerName').value,
        phone_number: document.getElementById('phoneNumber').value,
        delivery_date: document.getElementById('deliveryDate').value,
        additional_notes: document.getElementById('additionalNotes').value,
        measurements: []
      };
      // Collect measurements from dynamic fields
      const selectedTypes = Array.from(document.querySelectorAll('input[name="garment_types"]:checked')).map(cb => cb.value);
      selectedTypes.forEach(type => {
        const fields = {};
        fields.garment_type = type;
        fields.delivery_date = customerData.delivery_date;
        fields.additional_notes = customerData.additional_notes;
        // Get all inputs for this garment type
        const inputs = dynamicFields.querySelectorAll(`.garment-fields input[name]`);
        inputs.forEach(input => {
          if (input.closest('.garment-fields').querySelector('h3').textContent.toLowerCase().includes(type)) {
            // Convert to float if possible, else keep as string
            const val = input.value;
            fields[input.name] = val === '' ? null : (isNaN(val) ? val : parseFloat(val));
          }
        });
        customerData.measurements.push(fields);
      });
      // Send to backend
      fetch('/api/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(customerData)
      })
      .then(res => {
        if (res.status === 405) {
          throw new Error('Method Not Allowed: Check backend route and method.');
        }
        return res.json();
      })
      .then(data => {
        if (data.customer_id) {
          alert('Customer and measurements saved!');
          customerModal.style.display = 'none';
          measurementModal.style.display = 'none';
          customerForm.reset();
          measurementForm.reset();
          dynamicFields.innerHTML = '';
        } else {
          alert('Error: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        alert('Error: ' + err);
      });
    });
  });
</script>

        <!-- Customers List -->
        <section class="customers-section">
            <div class="section-header">
                <h2>Customer Orders</h2>
                <div class="header-actions">
                    <div class="customers-count">
                    <span id="customersCount">0</span> customers
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </div>
            <div id="customersList" class="customers-list">
                <!-- Customers will be loaded here -->
            </div>
        </section>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>